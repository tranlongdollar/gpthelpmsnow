name: Generate RAW Links

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  gen-rawlinks:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # cho phép bot commit vào repo

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      # Tạo script PHP sinh rawlink.md (tự túc, không phụ thuộc repo đã có sẵn script)
      - name: Create generator script
        run: |
          mkdir -p scripts
          cat > scripts/gen_rawlinks.php <<'PHP'
          <?php
          /**
           * gen_rawlinks.php
           * Tạo bảng RAW URL (Markdown) cho toàn bộ repo GitHub (hoặc 1 thư mục con).
           *
           * Cách dùng (quét toàn repo):
           *   php scripts/gen_rawlinks.php owner=<owner> repo=<repo> ref=main output=massagenow.vn/rawlink.md
           *
           * Tham số:
           *   owner=<owner>     bắt buộc
           *   repo=<repo>       bắt buộc
           *   ref=<branch|sha>  mặc định: main
           *   base=<subdir>     (tuỳ chọn) chỉ liệt kê dưới thư mục này (vd: massagenow.vn)
           *   output=<path>     (tuỳ chọn) file đầu ra (mặc định: rawlink.md hoặc massagenow.vn/rawlink.md nếu tồn tại)
           */
          declare(strict_types=1);

          parse_str(implode('&', array_slice($argv, 1)), $a);
          $owner  = (string)($a['owner'] ?? '');
          $repo   = (string)($a['repo']  ?? '');
          $ref    = (string)($a['ref']   ?? 'main');
          $base   = trim((string)($a['base'] ?? ''), '/');
          $output = (string)($a['output'] ?? '');

          if ($owner === '' || $repo === '') {
              fwrite(STDERR, "Usage: php scripts/gen_rawlinks.php owner=<owner> repo=<repo> [ref=<branch|sha>] [base=<subdir>] [output=<path>]\n");
              exit(1);
          }

          // --- gọi Git Trees API (recursive=1) ---
          $api = "https://api.github.com/repos/{$owner}/{$repo}/git/trees/".rawurlencode($ref)."?recursive=1";
          $ch = curl_init($api);
          curl_setopt_array($ch, [
              CURLOPT_RETURNTRANSFER => true,
              CURLOPT_FOLLOWLOCATION => true,
              CURLOPT_TIMEOUT        => 30,
              CURLOPT_HTTPHEADER     => [
                  'Accept: application/vnd.github+json',
                  'User-Agent: rawlinks-generator'
              ],
          ]);
          $resp = curl_exec($ch);
          $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
          curl_close($ch);
          if ($code !== 200 || !$resp) {
              fwrite(STDERR, "[ERR] GitHub API HTTP {$code} for {$api}\n");
              exit(2);
          }
          $json = json_decode($resp, true);
          $tree = $json['tree'] ?? [];
          if (!$tree) {
              fwrite(STDERR, "[ERR] Empty tree\n");
              exit(3);
          }

          // Lấy SHA commit (pinned) để có cột RAW ổn định theo commit
          $commitApi = "https://api.github.com/repos/{$owner}/{$repo}/comm
